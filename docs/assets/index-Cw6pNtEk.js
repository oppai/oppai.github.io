import{S as Te,P as ve,W as Ee,A as Ie,D as Oe,O as Ye,a as E,M as Y,b as z,c as T,B as ze,C as Ce,F as ae,d as Re,e as We,f as Fe,g as pe,V as B,h as Ge,R as me,T as he,i as je,j as Le,k as Ne}from"./vendor-three-DGfO6NI1.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))b(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const f of a.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&b(f)}).observe(document,{childList:!0,subtree:!0});function p(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function b(s){if(s.ep)return;s.ep=!0;const a=p(s);fetch(s.href,a)}})();const J=new Te,G=new ve(75,window.innerWidth/window.innerHeight,.1,1e3),j=new Ee({antialias:!0});j.setSize(window.innerWidth,window.innerHeight);j.setClearColor(0);G.position.z=7;const He=new Ie(16777215,1.5);J.add(He);const De=new Oe(16777215,.5);De.position.set(5,10,7.5);J.add(De);const R=new Ye(G,j.domElement);R.enableDamping=!0;R.dampingFactor=.05;R.screenSpacePanning=!1;R.minDistance=3;R.maxDistance=20;R.maxPolarAngle=Math.PI/2;function Be(){G.aspect=window.innerWidth/window.innerHeight,G.updateProjectionMatrix(),j.setSize(window.innerWidth,window.innerHeight)}window.addEventListener("resize",Be,!1);function Ke(n){const o=document.getElementById(n);o?o.appendChild(j.domElement):console.error(`Container with id '${n}' not found.`)}let l,D;const be=[],xe=[];let K;const q=[],F={kodam:null,tru:null,sup:null},fe=Object.keys(F);let ne=0;async function Je(n,o){const p=[o.loadAsync("/assets/kodam.avif").catch(e=>(console.error("Failed to load kodam",e),null)),o.loadAsync("/assets/gohst.avif").catch(e=>(console.error("Failed to load gohst",e),null)),o.loadAsync("/assets/effect.avif").catch(e=>(console.error("Failed to load effect",e),null)),o.loadAsync("/assets/cards.avif").catch(e=>(console.error("Failed to load cards",e),null)),o.loadAsync("/assets/ground.avif").catch(e=>(console.error("Failed to load ground",e),null)),o.loadAsync("/assets/ground-none.avif").catch(e=>(console.error("Failed to load ground-none",e),null)),o.loadAsync("/assets/wall.avif").catch(e=>(console.error("Failed to load wall",e),null)),o.loadAsync("/assets/kodam-tru.avif").catch(e=>(console.error("Failed to load kodam-tru",e),null)),o.loadAsync("/assets/kodam-sup.avif").catch(e=>(console.error("Failed to load kodam-sup",e),null))];let b,s,a,f,L,N,M,P,O;try{[b,s,a,f,L,N,M,P,O]=await Promise.all(p),F.kodam=b,F.tru=P,F.sup=O}catch(e){console.error("An error happened during parallel texture loading Promise.all:",e)}try{const e=F.kodam;if(e){const i=e.image.width/e.image.height,c=5,u=c*i,h=new E(u,c),d=new Y({map:e,side:z,transparent:!0,depthWrite:!1,alphaTest:.1});l=new T(h,d),l.userData.initialY=l.position.y,l.userData.time=0,l.userData.needsShakeAnimation=!1,l.renderOrder=2,l.name="kodam",n.add(l);const m=500,w=.03,r=new ze,y=[],I=[],x=[],V=new Ce(11184895);for(let de=0;de<m;de++){const Q=1.8+Math.pow(Math.random(),3)*1,ue=Math.random()*Math.PI*2,ee=Math.acos(Math.random()*2-1),Pe=Q*Math.sin(ee)*Math.cos(ue),Ae=Q*Math.sin(ee)*Math.sin(ue),Se=Q*Math.cos(ee)-.2;y.push(Pe,Ae,Se);const te=Math.random()*.3;I.push(V.r+te,V.g+te,V.b+te,1),x.push((Math.random()-.5)*.02,(Math.random()-.5)*.02,Math.random()*Math.PI*2)}r.setAttribute("position",new ae(y,3)),r.setAttribute("color",new ae(I,4)),r.setAttribute("velocity",new ae(x,3));const ke=new Re({size:w,sizeAttenuation:!0,vertexColors:!0,transparent:!0,blending:We,depthWrite:!1});K=new Fe(r,ke),K.userData.initialPositions=r.attributes.position.clone(),K.renderOrder=1,n.add(K)}else throw new Error("Initial Kodam texture failed to load.")}catch(e){console.error("An error happened setting up the kodam object or aura:",e);const i=new E(5,5),c=new pe({color:16711680});l=new T(i,c),l.userData.initialY=l.position.y,l.userData.time=0,l.userData.needsShakeAnimation=!1,l.renderOrder=2,l.name="kodam",n.add(l)}try{if(s){const e=s.image.width/s.image.height,i=2,c=i*e,u=new E(c,i),h=new Y({map:s,side:z,transparent:!0,depthWrite:!1,alphaTest:.1});D=new T(u,h),D.position.z=-.1,D.position.x=D.position.x-1.2,D.userData.initialY=D.position.y+2,D.userData.time=Math.PI,D.renderOrder=0,n.add(D)}else throw new Error("Gohst texture failed to load.")}catch(e){console.error("An error happened setting up the gohst object:",e);const i=new E(4,4),c=new pe({color:255});D=new T(i,c),D.position.z=-.1,n.add(D)}try{if(a){const e=a.image.width/a.image.height,i=3,c=i*e,u=new E(c,i),h=new Y({map:a,side:z,transparent:!0,depthWrite:!1,alphaTest:.1,opacity:.7}),d=new T(u,h.clone()),m=new T(u,h.clone()),w=D?D.position.clone():new B(0,0,-.2);w.x-=.7,w.y+=1,w.z-=.1,d.position.copy(w),m.position.copy(w),m.position.x+=4,d.rotation.z=Math.PI/4,m.rotation.z=-Math.PI/4,[d,m].forEach((r,y)=>{r.userData.initialY=r.position.y,r.userData.time=Math.random()*Math.PI*2,r.userData.speed=.015+Math.random()*.01,r.userData.amplitude=.15+Math.random()*.05,r.renderOrder=-1,n.add(r),xe.push(r)})}else throw new Error("Effect texture failed to load.")}catch(e){console.error("An error happened setting up the effect objects:",e)}try{if(f){const c=[new B(-2,-.4,.1),new B(2,-.4,.1),new B(-1.5,-.7,.1),new B(1.5,-.7,.1)],u=[{x:0,y:.5},{x:.65/2+.02,y:.5},{x:0,y:0},{x:.65/2+.02,y:0}];for(let h=0;h<4;h++){const d=f.clone();d.needsUpdate=!0,d.repeat.set(.5*.65,.5),d.offset.set(u[h].x,u[h].y);const m=new E(1*.65,1),w=new Y({map:d,side:z,transparent:!0,depthWrite:!1,alphaTest:.1}),r=new T(m,w);r.position.copy(c[h]),r.userData.initialY=r.position.y,r.userData.initialZ=r.position.z,r.userData.time=Math.random()*Math.PI*2,r.userData.speed=.01+Math.random()*.02,r.userData.amplitude=.1+Math.random()*.05,r.renderOrder=3,n.add(r),be.push(r)}}else throw new Error("Cards texture failed to load.")}catch(e){console.error("An error happened setting up the card objects:",e)}try{if(L&&N){const e=document.createElement("canvas"),i=e.getContext("2d"),c=1024;e.width=c,e.height=c;const u=L.image,h=N.image;if(u&&h){i.fillStyle=i.createPattern(h,"repeat"),i.fillRect(0,0,e.width,e.height);const y=c/8,I=(c-y)/2,x=(c-y)/2;i.drawImage(u,I,x,y,y)}else{console.error("Background images not loaded for canvas drawing."),i.fillStyle="grey",i.fillRect(0,0,e.width,e.height),i.fillStyle="darkgrey";const y=c/4,I=(c-y)/2,x=(c-y)/2;i.fillRect(I,x,y,y)}const d=new Ge(e);d.needsUpdate=!0;const m=new E(50,50),w=new Y({map:d,side:z}),r=new T(m,w);r.rotation.x=-Math.PI/2,r.position.y=-2.5,r.renderOrder=-3,n.add(r)}else throw new Error("Background textures failed to load.")}catch(e){console.error("An error happened creating the ground canvas texture:",e)}try{if(M){M.wrapS=me,M.wrapT=me;const e=5;M.repeat.set(e,e);const i=new E(50,50),c=new Y({map:M,side:z}),u=new T(i,c);u.position.y=7.5,u.position.z=-10,u.renderOrder=-4,n.add(u)}else throw new Error("Wall texture failed to load.")}catch(e){console.error("An error happened creating the wall object:",e)}const t=1,g=1,A=3,H=[{name:"x",file:"/assets/x.avif",url:"https://x.com/kodam"},{name:"github",file:"/assets/github.avif",url:"https://github.com/oppai"},{name:"cv",file:"/assets/cv.avif",url:"https://gist.github.com/oppai/5e10c6bd03c9d53f50564a369be2f940"}],S=[{name:"ai",file:"/assets/ai.avif",url:"https://note.com/0ppai"},{name:"poker",file:"/assets/poker.avif",url:"https://note.com/brianpoker"}];async function k(e,i,c=0){const u=-(e.length-1)*g/2,h=e.map(d=>o.loadAsync(d.file).catch(m=>(console.error(`Failed to load texture ${d.file}:`,m),null)));try{const d=await Promise.all(h);for(let m=0;m<e.length;m++){const w=e[m],r=d[m];if(!r){console.warn(`Skipping link plane for ${w.name} due to texture load failure.`);continue}const y=new E(t,t),I=new Y({map:r,side:z,transparent:!0,depthWrite:!1,alphaTest:.1}),x=new T(y,I);x.position.x=u+m*g,x.position.y=i,x.position.z=A,x.userData={type:"link",name:w.name,url:w.url,initialY:i,initialZ:A},x.renderOrder=4+c,n.add(x),q.push(x)}}catch(d){console.error(`An error happened creating link row at y=${i}:`,d)}}await k(H,-2,0),await k(S,2.5,1)}function $e(){if(!l||!l.material){console.warn("Kodam plane or material not ready for expression change.");return}ne=(ne+1)%fe.length;const n=fe[ne],o=F[n];o?(l.material.map=o,l.userData.needsShakeAnimation=!0):console.warn(`Texture for expression "${n}" is not loaded.`)}let W;async function Xe(n){try{const o=await fetch("./assets/nebulaConfig.json");if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const p=await o.json();W=await Nebula.System.fromJSONAsync(p,he);const b=new Nebula.SpriteRenderer(n,he);W=W.addRenderer(b),b.target?(b.target.renderOrder=-2,b.target.material?(b.target.material.depthWrite=!1,b.target.material.depthTest=!1):console.warn("Could not find Nebula renderer target material to set depthWrite/depthTest.")):console.warn("Could not find Nebula renderer target to set renderOrder/depthWrite/depthTest."),W.updateEmitterPosition=(s,a)=>{if(a&&s){const f=a.position.clone();f.y-=1,s.position.copy(f),s.position.z-=.5}}}catch(o){console.error("Error loading or setting up Nebula system:",o),W=null}return W}let re=null;const _=3;let v=_,U=0;const ge=.2,Ue=.04;let Z="JIGGLING",oe=0;const Ze=60,we=.4,_e=.05,qe=25;function Me(n){const{scene:o,camera:p,renderer:b,controls:s,planeKodam:a,planeGohst:f,cardMeshes:L,effectMeshes:N,auraParticles:M,linkMeshes:P,nebulaSystem:O}=n;if(re=requestAnimationFrame(()=>Me(n)),a&&(a.userData.time+=.02,a.position.y=a.userData.initialY+Math.sin(a.userData.time)*.2,a.userData.needsShakeAnimation&&(a.userData.isShaking=!0,a.userData.shakeStartTime=Date.now()*.001,a.userData.needsShakeAnimation=!1),a.userData.isShaking)){const t=Date.now()*.001-a.userData.shakeStartTime;t<we?a.position.x=Math.sin(t*qe)*_e*(1-t/we):(a.userData.isShaking=!1,a.position.x=0)}if(f&&(f.userData.time+=.025,f.position.y=f.userData.initialY+Math.sin(f.userData.time)*.4),L.forEach(t=>{t.userData.time+=t.userData.speed,t.position.y=t.userData.initialY+Math.sin(t.userData.time)*t.userData.amplitude,t.rotation.z=Math.sin(t.userData.time)*.1}),N.forEach(t=>{t.userData.time+=t.userData.speed,t.position.y=t.userData.initialY+Math.sin(t.userData.time)*t.userData.amplitude}),P&&P.length>0)if(Z==="JIGGLING"){U+=1;const t=P[v];if(t&&t.userData&&typeof t.userData.initialY<"u"){const g=Math.sin(U*ge)*Ue;t.position.y=t.userData.initialY+g}else t&&console.warn(`Missing userData or initialY for active link index ${v}`);if(P.forEach((g,A)=>{A!==v&&g.userData&&typeof g.userData.initialY<"u"&&g.position.y!==g.userData.initialY&&(g.position.y=g.userData.initialY)}),U*ge>=Math.PI*2){t&&t.userData&&(t.position.y=t.userData.initialY),U=0;const g=v>=_,A=v===P.length-1,H=v===_-1;g?A?v=0:v++:H?(Z="PAUSED",oe=0,P.forEach(S=>{S&&S.userData&&(S.position.y=S.userData.initialY)})):v++}}else Z==="PAUSED"&&(oe++,P.forEach(t=>{t&&t.userData&&t.position.y!==t.userData.initialY&&(t.position.y=t.userData.initialY)}),oe>=Ze&&(Z="JIGGLING",v=_));if(O&&a){const t=O.emitters[0];t&&O.updateEmitterPosition(t,a),O.update()}if(M&&a){M.position.copy(a.position);const t=M.geometry.attributes.position,g=M.geometry.attributes.color,A=M.userData.initialPositions,H=M.geometry.attributes.velocity,S=Date.now()*.0015;for(let k=0;k<t.count;k++){const ce=A.getX(k),le=A.getY(k);A.getZ(k);const e=H.getZ(k);t.setX(k,ce+Math.sin(S*1.5+e)*.12),t.setY(k,le+Math.cos(S*1.5+e)*.12);const i=Math.abs(Math.sin(S*2+e));g.setW(k,i)}t.needsUpdate=!0,g.needsUpdate=!0}s.update(),b.render(o,p)}function Ve(n){re&&cancelAnimationFrame(re),Me(n)}let $,C,ie,X=[],ye=0;function Qe(n){ie=n,$=new je,C=new Le,X=[...q],window.addEventListener("click",et,!1),window.addEventListener("mousemove",tt,!1)}function se(){X=[...q],l&&X.push(l)}function et(n){C.x=n.clientX/window.innerWidth*2-1,C.y=-(n.clientY/window.innerHeight)*2+1,$.setFromCamera(C,ie),se();const o=$.intersectObjects(X);if(o.length>0){const p=o[0].object;p.name==="kodam"?(ye++,ye%5===0&&$e()):p.userData&&p.userData.type==="link"&&(console.log("Link clicked:",p.userData.url),window.open(p.userData.url,"_blank"))}}function tt(n){C.x=n.clientX/window.innerWidth*2-1,C.y=-(n.clientY/window.innerHeight)*2+1,$.setFromCamera(C,ie),se();const o=$.intersectObjects(X);if(o.length>0){const p=o[0].object;p.name==="kodam"||p.userData&&p.userData.type==="link"?document.body.style.cursor="pointer":document.body.style.cursor="default"}else document.body.style.cursor="default"}async function at(){Ke("canvas-container");const n=new Ne;await Je(J,n);const o=await Xe(J);Qe(G),Ve({scene:J,camera:G,renderer:j,controls:R,planeKodam:l,planeGohst:D,cardMeshes:be,effectMeshes:xe,auraParticles:K,linkMeshes:q,nebulaSystem:o}),se()}at().catch(n=>{console.error("Initialization failed:",n)});
